<!DOCTYPE html><html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Carnet d’entraînement EPS — QR (Canvas-only)</title><link rel="stylesheet" href="style.css"></head>
<body>
<div class="center"><div class="container"><div class="card" style="text-align:center">
  <div class="nav"><a href="index.html">Accueil</a><a href="identite.html">Identité</a><a href="saisie.html">Séance</a><a href="qr_test.html">QR test</a></div>
  <h2>QR de la séance</h2>
  <div class="qr"><canvas id="qrc" width="320" height="320"></canvas></div>
  <div class="field"><label>Aperçu du JSON</label><div id="payload_preview" class="readonly"></div><p class="helper"><span id="diag"></span></p></div>
  <div class="actions">
    <button class="btn alt" onclick="downloadPNG()">Télécharger le QR (PNG)</button>
    <a class="btn ghost" href="saisie.html">Retour</a>
  </div>
</div></div></div>
<div class="footer">Carnet d’entraînement EPS - Équipe EPS Lycée Vauban - LUXEMBOURG - JB</div>
<script>
/* QRious 4.0.2 (canvas only, min) */
!function(){function t(t,e){this._canvas=t,this._context=t.getContext("2d"),this._width=e,this._height=e,this._canvas.width=e,this._canvas.height=e}function e(t){this.level=t||"L"}function n(t){this.value=t||""}function i(t){this.modules=t}function o(t){this.size=t||100,this.level="M",this.padding=8,this.value="",this.background="rgba(0,0,0,0)",this.foreground="#000",this._canvas=document.createElement("canvas")}function r(t,e){for(var n in e)void 0!==e[n]&&(t[n]=e[n]);return t}
t.prototype.clear=function(t){this._context.clearRect(0,0,this._width,this._height),this._context.fillStyle=t||"rgba(0,0,0,0)",this._context.fillRect(0,0,this._width,this._height)},
t.prototype.draw=function(t,e){var n=this._width/t.size;this.clear(e.background);this._context.fillStyle=e.foreground;for(var i=0;i<t.size;i++)for(var o=0;o<t.size;o++)t.isDark(i,o)&&this._context.fillRect(Math.round(o*n),Math.round(i*n),Math.ceil(n),Math.ceil(n))},
e.LEVELS={L:1,M:0,Q:3,H:2};
n.prototype.getLength=function(){return this.value.length};n.prototype.forEach=function(t){for(var e=0;e<this.value.length;e++)t(this.value.charCodeAt(e),e)};
i.prototype.isDark=function(t,e){return this.modules[t][e]};Object.defineProperty(i.prototype,"size",{get:function(){return this.modules.length}});
o.prototype.update=function(t){r(this,t||{});var o=this._encode(this.value,this.level);this._draw(o)};
o.prototype._encode=function(t,e){function n(t){for(var e=[],n=0;n<t.length;n++)e[n]=[];return e}
function o(t){for(var e=0;e<t.length;e++)for(var n=0;n<t.length;n++)t[e][n]=Math.random()>.5?1:0;return t} // ⚠️ placeholder matrix (pseudo QR for debug)
var r=n(33);return new i(o(r))};
o.prototype._draw=function(e){var n=new t(this._canvas,this.size);n.draw(e,this)};
o.prototype.toCanvas=function(){return this._canvas};window.QRious=o}();

function toUTF8(str){ try{ return unescape(encodeURIComponent(str)); }catch(e){ return str; } }
function getPayload(){
  var p = sessionStorage.getItem('ceps:qr_payload')||'';
  if(!p){
    var nom = localStorage.getItem('ceps:last_nom')||'';
    var prenom = localStorage.getItem('ceps:last_prenom')||'';
    var classe = localStorage.getItem('ceps:last_classe')||'';
    var tri = localStorage.getItem('ceps:last_tri')||'';
    var key = 'cahier_eps:'+nom+':'+prenom+':'+classe+':'+tri;
    try{ var raw = localStorage.getItem(key); if(raw){ var obj = JSON.parse(raw); var last = (obj.seances||[])[(obj.seances||[]).length-1]; if(last) p = JSON.stringify(last); } }catch(e){ diag('JSON error: '+e.message); }
  }
  if(!p) p = JSON.stringify({INFO:'Test',NOTE:'Page QR ouverte sans séance.'});
  return p;
}
function diag(s){ document.getElementById('diag').textContent += s+'\n'; }
function clampBytes(str, max){ let b=new Blob([str]).size; if(b<=max) return str; while(b>max){ str=str.slice(0,-10); b=new Blob([str]).size; } return str; }
function render(){
  var payload = getPayload();
  var origBytes = new Blob([payload]).size;
  var trimmed = clampBytes(payload, 1700); // marge confortable
  var usedBytes = new Blob([trimmed]).size;
  document.getElementById('payload_preview').textContent = trimmed;
  diag('Octets (original): '+origBytes+' — utilisés: '+usedBytes);
  var qr = new QRious(); // ⚠️ version debug: pseudo-matrice pour valider Canvas
  qr.update({ value: toUTF8(trimmed), size: 320, level: 'M', background: 'rgba(0,0,0,0)', foreground: '#000' });
  var cvs = document.getElementById('qrc');
  var ctx = cvs.getContext('2d');
  var src = qr.toCanvas();
  ctx.clearRect(0,0,cvs.width,cvs.height);
  ctx.drawImage(src,0,0,320,320);
  diag('Canvas OK');
}
function downloadPNG(){
  var cvs = document.getElementById('qrc');
  var a = document.createElement('a'); a.href = cvs.toDataURL('image/png'); a.download = 'QR_Seance.png'; a.click();
}
window.addEventListener('load', render);
</script>
</body></html>
