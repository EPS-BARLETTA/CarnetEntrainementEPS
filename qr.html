<!DOCTYPE html><html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Carnet d’entraînement EPS — QR (SVG via CDN)</title><link rel="stylesheet" href="style.css">
<!-- Librairie fiable depuis CDNJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
</head>
<body>
<div class="center"><div class="container"><div class="card" style="text-align:center">
  <div class="nav"><a href="index.html">Accueil</a><a href="identite.html">Identité</a><a href="saisie.html">Séance</a><a href="qr_test.html">QR test</a></div>
  <h2>QR de la séance (SVG)</h2>
  <div id="qrc" class="qr"></div>
  <div class="field"><label>Aperçu du JSON</label><div id="payload_preview" class="readonly"></div><p class="helper"><span id="diag"></span></p></div>
  <div class="actions">
    <button class="btn alt" onclick="downloadSVG()">Télécharger le QR (SVG)</button>
    <a class="btn ghost" href="saisie.html">Retour</a>
  </div>
</div></div></div>
<div class="footer">Carnet d’entraînement EPS - Équipe EPS Lycée Vauban - LUXEMBOURG - JB</div>
<script>
function bytes(s){ return new Blob([s]).size; }
function diag(s){ document.getElementById('diag').textContent = s; }
function getPayload(){
  var p = sessionStorage.getItem('ceps:qr_payload')||'';
  if(!p){
    var nom = localStorage.getItem('ceps:last_nom')||'';
    var prenom = localStorage.getItem('ceps:last_prenom')||'';
    var classe = localStorage.getItem('ceps:last_classe')||'';
    var tri = localStorage.getItem('ceps:last_tri')||'';
    var key = 'cahier_eps:'+nom+':'+prenom+':'+classe+':'+tri;
    try{ var raw = localStorage.getItem(key); if(raw){ var obj = JSON.parse(raw); var last = (obj.seances||[])[(obj.seances||[]).length-1]; if(last) p = JSON.stringify(last); } }catch(e){ diag('JSON error: '+e.message); }
  }
  if(!p) p = JSON.stringify({INFO:'Test',NOTE:'Page QR ouverte sans séance.'});
  return p;
}
function render(){
  var payload = getPayload();
  document.getElementById('payload_preview').textContent = payload;
  diag('Octets: '+bytes(payload));
  var q = qrcode(0, 'M'); // version auto, ECC M
  q.addData(payload); q.make();
  document.getElementById('qrc').innerHTML = q.createSvgTag(6,0);
}
function downloadSVG(){
  const svg = document.querySelector('#qrc svg'); if(!svg) return alert('Pas de SVG.');
  const blob = new Blob([svg.outerHTML], {type:'image/svg+xml'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='QR_Seance.svg'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000);
}
window.addEventListener('load', render);
</script>
</body></html>
