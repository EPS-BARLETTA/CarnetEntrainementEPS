<!DOCTYPE html><html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Carnet d’entraînement EPS — QR (inline)</title><link rel="stylesheet" href="style.css"></head>
<body>
<div class="center"><div class="container"><div class="card" style="text-align:center">
  <div class="nav"><a href="index.html">Accueil</a><a href="identite.html">Identité</a><a href="saisie.html">Séance</a><a href="qr_test.html">QR test</a></div>
  <h2>QR de la séance</h2>
  <div id="qrc" class="qr"></div>
  <div class="field"><label>Aperçu du JSON</label><div id="payload_preview" class="readonly"></div><p class="helper"><span id="diag"></span></p></div>
  <div class="actions">
    <button class="btn alt" onclick="downloadPNG()">Télécharger le QR (PNG)</button>
    <a class="btn ghost" href="saisie.html">Retour</a>
  </div>
</div></div></div>
<div class="footer">Carnet d’entraînement EPS - Équipe EPS Lycée Vauban - LUXEMBOURG - JB</div>
<script>
// === QR lib (inline) ===
/*! QRCode.js v1.0 (compact) */
!function(){function t(t){this.mode=o.MODE_8BIT_BYTE,this.data=t}
function e(t,e){this.typeNumber=t,this.errorCorrectLevel=e,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}
function r(t,e){if(void 0==t.length)throw new Error(t.length+"/"+e);for(var r=0;r<t.length&&0==t[r];)r++;this.num=new Array(t.length-r+e);for(var n=0;n<t.length-r;n++)this.num[n]=t[n+r]}
function n(t,e){this.totalCount=t,this.dataCount=e}
function i(){this.buffer=[],this.length=0}
i.prototype={get:function(t){var e=Math.floor(t/8);return 1==(this.buffer[e]>>>7-t%8&1)},put:function(t,e){for(var r=0;r<e;r++)this.putBit(1==(t>>>e-r-1&1))},getLengthInBits:function(){return this.length},putBit:function(t){var e=Math.floor(this.length/8);this.buffer.length<=e&&this.buffer.push(0),t&&(this.buffer[e]|=128>>>this.length%8),this.length++}};
var o={};o.PAD0=236,o.PAD1=17,o.MODE_NUMBER=1,o.MODE_ALPHA_NUM=2,o.MODE_8BIT_BYTE=4,o.MODE_KANJI=8,o.ErrorCorrectLevel={L:1,M:0,Q:3,H:2};
var a={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54]],
G15:1335,G18:7973,G15_MASK:21522,getBCHDigit:function(t){for(var e=0;0!=t;)e++,t>>>=1;return e},
getBCHTypeInfo:function(t){for(var e=t<<10;0<=a.getBCHDigit(e)-a.getBCHDigit(a.G15);)e^=a.G15<<a.getBCHDigit(e)-a.getBCHDigit(a.G15);return t<<10|e},
getBCHTypeNumber:function(t){for(var e=t<<12;0<=a.getBCHDigit(e)-a.getBCHDigit(a.G18);)e^=a.G18<<a.getBCHDigit(e)-a.getBCHDigit(a.G18);return t<<12|e},
getPatternPosition:function(t){return a.PATTERN_POSITION_TABLE[t-1]},
getMask:function(t,e){switch(t){case 0:return(e%2+Math.floor(e/2)%2)%2==0;case 1:return e%2==0;case 2:return Math.floor(e/2)%2==0;case 3:return(e%2+Math.floor(e/2)%2)%2==0;case 4:return(e%3+Math.floor(e/3)%2)%2==0;case 5:return(e%3+e%2)%2==0;case 6:return(e%3+Math.floor(e/2)%2)%2==0;case 7:return(e%3+e+Math.floor(e/2)%2)%2==0;default:throw new Error("bad maskPattern:"+t)}},
getErrorCorrectPolynomial:function(t){for(var e=new r([1],0),n=0;n<t;n++)e=e.multiply(new r([1,Math.pow(2,n)],0));return e}};
r.prototype={get:function(t){return this.num[t]},getLength:function(){return this.num.length},multiply:function(t){for(var e=new Array(this.getLength()+t.getLength()-1),n=0;n<this.getLength();n++)for(var i=0;i<t.getLength();i++)e[n+i]^=a.gexp(a.glog(this.get(n))+a.glog(t.get(i)));return new r(e,0)},
mod:function(t){if(this.getLength()-t.getLength()<0)return this;for(var e=a.glog(this.get(0))-a.glog(t.get(0)),n=new Array(this.getLength()),i=0;i<this.getLength();i++)n[i]=this.get(i);for(i=0;i<t.getLength();i++)n[i]^=a.gexp(a.glog(t.get(i))+e);return new r(n,0).mod(t)}};
a.glog=function(t){if(t<1)throw new Error("glog("+t+")");return a.LOG_TABLE[t]},a.gexp=function(t){for(;t<0;)t+=255;for(;t>=256;)t-=255;return a.EXP_TABLE[t]},a.LOG_TABLE=new Array(256),a.EXP_TABLE=new Array(256);
for(var s=0;s<8;s++)a.EXP_TABLE[s]=1<<s;for(s=8;s<256;s++)a.EXP_TABLE[s]=a.EXP_TABLE[s-4]^a.EXP_TABLE[s-5]^a.EXP_TABLE[s-6]^a.EXP_TABLE[s-8];
for(s=0;s<255;s++)a.LOG_TABLE[a.EXP_TABLE[s]]=s;
e.prototype={addData:function(e){this.dataList.push(new t(e)),this.dataCache=null},
isDark:function(t,e){if(0>t||this.moduleCount<=t||0>e||this.moduleCount<=e)throw new Error(t+","+e);return this.modules[t][e]},
getModuleCount:function(){return this.moduleCount},
make:function(){if(this.typeNumber<1)this.typeNumber=1;this.dataCache=u.createData(this.typeNumber,this.errorCorrectLevel,this.dataList),this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var t=0;t<this.moduleCount;t++){this.modules[t]=new Array(this.moduleCount);for(var r=0;r<this.moduleCount;r++)this.modules[t][r]=null}u.setupPositionProbePattern(this,0,0),u.setupPositionProbePattern(this,this.moduleCount-7,0),u.setupPositionProbePattern(this,0,this.moduleCount-7),
u.setupPositionAdjustPattern(this),u.setupTimingPattern(this),u.setupTypeInfo(this,!1),this.typeNumber>=7&&u.setupTypeNumber(this,!1),null==this.dataCache&&(this.dataCache=u.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),u.mapData(this,this.dataCache)} };
var u={createData:function(t,r,n){for(var o=new i,a=0;a<n.length;a++){var s=n[a];o.put(4,4),o.put(s.data.length,8);for(var l=0;l<s.data.length;l++)o.put(s.data.charCodeAt(l),8)}var h=u.getBestTypeNumber(o,r,t);t=h;for(var c=f.getRSBlocks(t,r),d=new i,a=0;a<c.length;a++)d.put(4,4),d.put(n[a].data.length,8),d.buffer=d.buffer.concat(n[a].data.split("").map(function(t){return t.charCodeAt(0)})),d.length=o.length;var p=m(c,d.getLengthInBits());return g(c,d,p)},
getBestTypeNumber:function(t,e,r){for(var n=1;n<=10;n++){var i=f.getRSBlocks(n,e),o=m(i,t.getLengthInBits());if(o>=0){r=n;return n}}return 10},
setupPositionProbePattern:function(t,e,r){for(var n=-1;n<=7;n++)if(!(e+n<=-1||t.moduleCount<=e+n))for(var i=-1;i<=7;i++)r+i<=-1||t.moduleCount<=r+i||(t.modules[e+n][r+i]=n>=0&&n<=6&&(0==i||6==i)||i>=0&&i<=6&&(0==n||6==n)||n>=2&&n<=4&&i>=2&&i<=4)},
setupTimingPattern:function(t){for(var e=8;e<t.moduleCount-8;e++)null==t.modules[e][6]&&(t.modules[e][6]=e%2==0),null==t.modules[6][e]&&(t.modules[6][e]=e%2==0)},
setupPositionAdjustPattern:function(t){for(var e=a.getPatternPosition(t.typeNumber),r=0;r<e.length;r++)for(var n=0;n<e.length;n++){var i=e[r],o=e[n];if(null==t.modules[i][o])for(var s=-2;s<=2;s++)for(var l=-2;l<=2;l++)t.modules[i+s][o+l]=s== -2||s==2||l==-2||l==2||0==s&&0==l}},
setupTypeNumber:function(t,e){for(var r=a.getBCHTypeNumber(t.typeNumber),n=0;n<18;n++){var i=!e&&1==(r>>n&1);t.modules[Math.floor(n/3)][n%3+t.moduleCount-8-3]=i,t.modules[n%3+8][Math.floor(n/3)]=i}},
setupTypeInfo:function(t,e){for(var r=a.getBCHTypeInfo(o.ErrorCorrectLevel.M<<3|0),n=0;n<15;n++){var i=!e&&1==(r>>n&1);n<6?t.modules[n][8]=i:n<8?t.modules[n+1][8]=i:t.modules[t.moduleCount-15+n][8]=i}for(n=0;n<15;n++){i=!e&&1==(r>>n&1);n<8?t.modules[8][t.moduleCount-n-1]=i:n<9?t.modules[8][15-n-1+1]=i:t.modules[8][15-n-1]=i}},
mapData:function(t,e){for(var r= -1,n=t.moduleCount-1,i=7,o=0,a=!1;n>0;n-=2){6==n&&n--;for(;;){for(var s=0;s<2;s++)if(null==t.modules[n-s][r]){var l=!1;o<e.length&&(l=1==(e[o]>>>i&1)),u.isMasked(n-s,r,0)?t.modules[n-s][r]=!l:t.modules[n-s][r]=l,o++,i==-1&&(i=7)}if(a){if(r++,r==t.moduleCount)break}else if((r--,-1==r))break}a=!a}},
isMasked:function(t,e,r){return a.getMask(r,t,e)}};
var f={getRSBlocks:function(t,e){var r=[[1,[n(19,7)]],[1,[n(34,10)]],[1,[n(55,15)]],[1,[n(80,20)]],[1,[n(108,26)]],[1,[n(136,18)]],[1,[n(156,20)]],[1,[n(194,24)]],[1,[n(232,30)]],[1,[n(274,18)]]];return r[t-1][0],r[t-1][1]},
RSBlock:n},m=function(t,e){for(var r=0,n=0;n<t.length;n++)r+=t[n].dataCount;var i=8*r;return e<=i?i-e:-1},g=function(t,e,r){for(var n=[],i=0;i<t.length;i++){for(var o=t[i].dataCount,a=t[i].totalCount-o,s=[],l=0;l<o;l++)s.push(0);n.push({dataCount:o,totalCount:t[i].totalCount,buffer:s})}for(i=0;i<n.length;i++);var h=[];for(i=0;i<n.length;i++)h=h.concat(n[i].buffer);return h},d=function(t,e){this._el=t,this._htOption={width:e.width||256,height:e.height||256,text:e.text||"",correctLevel:o.ErrorCorrectLevel.M},this._oQRCode=null,this._oDrawing=null,this.makeCode(this._htOption.text)};
d.prototype.makeCode=function(t){this._oQRCode=new e(10,this._htOption.correctLevel),this._oQRCode.addData(t),this._oQRCode.make(),this._oDrawing=new p(this._el,this._htOption),this._oDrawing.draw(this._oQRCode)};
var p=function(t,e){this._el=t,this._htOption=e,this._el.innerHTML="",this._el.style.position="relative"};
p.prototype.draw=function(t){var e=document.createElement("canvas");e.width=this._htOption.width,e.height=this._htOption.height,this._el.appendChild(e);for(var r=e.getContext("2d"),n=this._htOption.width/t.getModuleCount(),i=this._htOption.height/t.getModuleCount(),o=0;o<t.getModuleCount();o++)for(var a=0;a<t.getModuleCount();a++)t.isDark(o,a)&&r.fillRect(Math.round(a*i),Math.round(o*n),Math.ceil(i),Math.ceil(n))};
window.QRCode=d,window.QRCode.CorrectLevel=o.ErrorCorrectLevel;
}();

// === helpers ===
function log(s){document.getElementById('diag').textContent = (document.getElementById('diag').textContent||'') + s + '\n';}
function toUTF8(str){ try { return unescape(encodeURIComponent(str)); } catch(e) { return str; } }
function getPayload(){
  var p = sessionStorage.getItem('ceps:qr_payload')||'';
  if(!p){
    var nom = localStorage.getItem('ceps:last_nom')||'';
    var prenom = localStorage.getItem('ceps:last_prenom')||'';
    var classe = localStorage.getItem('ceps:last_classe')||'';
    var tri = localStorage.getItem('ceps:last_tri')||'';
    var key = 'cahier_eps:'+nom+':'+prenom+':'+classe+':'+tri;
    try{ var raw = localStorage.getItem(key); if(raw){ var obj = JSON.parse(raw); var last = (obj.seances||[])[(obj.seances||[]).length-1]; if(last) p = JSON.stringify(last); } }catch(e){ log('JSON error: '+e.message); }
  }
  if(!p) p = JSON.stringify({INFO:'Test',NOTE:'Page QR ouverte sans séance.'});
  return p;
}
function render(){
  var payload = getPayload();
  document.getElementById('payload_preview').textContent = payload;
  log('Octets: '+ new Blob([payload]).size);
  var box = document.getElementById('qrc'); box.innerHTML='';
  try{ new QRCode(box, { text: toUTF8(payload), width: 320, height: 320, correctLevel: QRCode.CorrectLevel.M }); log('QR OK'); }
  catch(e){ box.textContent='Erreur de génération du QR.'; log('QR error: '+e.message); }
}
function downloadPNG(){
  var img = document.querySelector('#qrc img');
  var canvas = document.querySelector('#qrc canvas');
  var src = img ? img.src : (canvas ? canvas.toDataURL('image/png') : null);
  if(!src){ alert('QR non disponible.'); return; }
  var a = document.createElement('a'); a.href = src; a.download = 'QR_Seance.png'; a.click();
}
window.addEventListener('load', render);
</script>
</body></html>
