<!DOCTYPE html><html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Séance</title><link rel="stylesheet" href="style.css"></head>
<body>
<div class="container">
  <div class="card">
    <div class="nav"><a href="index.html">Accueil</a><a href="identite.html">Identité</a><a href="saisie.html">Séance</a><a href="qr.html">QR</a><a href="qr_test.html">QR test</a></div>
    <h2>Saisie libre</h2>
    <p class="subtitle" id="who"></p>
    <div class="field"><label>Notes</label><textarea id="notes" placeholder="Écris qqchose"></textarea></div>
    <div class="actions">
      <button class="btn cta" onclick="save()">Enregistrer ma séance</button>
      <button class="btn alt" onclick="goQR()">Générer QR code</button>
    </div>
  </div>
</div>
<div class="footer">Carnet d’entraînement EPS - Équipe EPS Lycée Vauban - LUXEMBOURG - JB</div>
<script>
(function(){
  const nom = localStorage.getItem("ceps:last_nom")||"";
  const prenom = localStorage.getItem("ceps:last_prenom")||"";
  const classe = localStorage.getItem("ceps:last_classe")||"";
  const tri = localStorage.getItem("ceps:last_tri")||"";
  const apsa = localStorage.getItem("ceps:last_apsa")||"";
  document.getElementById("who").textContent = nom+" "+prenom+" — "+classe+" — "+tri+" — "+apsa;
})();
function keyBy(nom, prenom, classe, tri){ return "cahier_eps:"+nom+":"+prenom+":"+classe+":"+tri; }
function loadCahier(nom, prenom, classe, tri){
  const raw = localStorage.getItem(keyBy(nom, prenom, classe, tri));
  if(!raw) return { meta:{}, seances:[] };
  try { return JSON.parse(raw); } catch(e){ return {meta:{}, seances:[]}; }
}
function saveCahier(nom, prenom, classe, tri, data){
  data.meta = Object.assign({}, data.meta||{}, {updated_at:new Date().toISOString()});
  localStorage.setItem(keyBy(nom, prenom, classe, tri), JSON.stringify(data));
}
function save(){
  const nom = localStorage.getItem("ceps:last_nom")||"";
  const prenom = localStorage.getItem("ceps:last_prenom")||"";
  const classe = localStorage.getItem("ceps:last_classe")||"";
  const tri = localStorage.getItem("ceps:last_tri")||"";
  const apsa = localStorage.getItem("ceps:last_apsa")||"";
  const d = loadCahier(nom, prenom, classe, tri);
  const row = {
    "Séance": (d.seances?.length||0)+1,
    "Nom": nom, "Prénom": prenom, "Classe": classe, "Trimestre": tri,
    "Date": new Date().toISOString().slice(0,10),
    "Semaine": "W00",
    "Activité": apsa,
    "Texte": (document.getElementById("notes").value||"")
  };
  d.seances = d.seances||[]; d.seances.push(row); saveCahier(nom, prenom, classe, tri, d);
  alert("Séance enregistrée.");
}
function goQR(){
  const nom = localStorage.getItem("ceps:last_nom")||"";
  const prenom = localStorage.getItem("ceps:last_prenom")||"";
  const classe = localStorage.getItem("ceps:last_classe")||"";
  const tri = localStorage.getItem("ceps:last_tri")||"";
  const key = keyBy(nom, prenom, classe, tri);
  const d = loadCahier(nom, prenom, classe, tri);
  const last = (d.seances||[])[(d.seances||[]).length-1];
  const payload = last ? JSON.stringify(last) : JSON.stringify({INFO:"No session"});
  try{ sessionStorage.setItem("ceps:qr_payload", payload); }catch(e){}
  location.href = "qr.html";
}
</script>
</body></html>
