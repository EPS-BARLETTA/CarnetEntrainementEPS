<!DOCTYPE html><html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>S√©ances ‚Äî V7.1</title><link rel="stylesheet" href="style.css">
<script>
function keyBy(nom, prenom, classe, tri){ return "cahier_eps:"+nom+":"+prenom+":"+classe+":"+tri; }
function loadCahier(nom, prenom, classe, tri){
  const raw = localStorage.getItem(keyBy(nom, prenom, classe, tri));
  if(!raw) return { meta:{}, seances:[] };
  try { return JSON.parse(raw); } catch(e) { return { meta:{}, seances:[] }; }
}
function saveCahier(nom, prenom, classe, tri, data){
  data.meta = Object.assign({}, data.meta||{}, {updated_at:new Date().toISOString()});
  localStorage.setItem(keyBy(nom, prenom, classe, tri), JSON.stringify(data));
}
function countWords(s){ return (String(s).trim().match(/\S+/g)||[]).length; }
function isoWeek(d){
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1)/7);
  return date.getUTCFullYear() + "-W" + String(weekNo).padStart(2,'0');
}
let EDIT_INDEX = null;
</script>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="nav">
      <a href="index.html">Accueil</a>
      <a href="identite.html">Identit√©</a>
      <a href="saisie.html">S√©ances</a>
      <a href="qr_test.html">QR test</a>
    </div>
    <h2>Nouvelle s√©ance</h2>
    <p class="subtitle" id="who"></p>
    <div class="field"><label>Notes / Infos</label>
      <textarea id="notes" placeholder="Court et clair."></textarea>
      <div class="counts"><span id="chars">0 caract√®res</span><span id="words">0 mots</span></div>
    </div>
    <div class="actions">
      <button class="btn cta" id="saveBtn">Enregistrer ma s√©ance</button>
      <button class="btn ghost" id="clearBtn">Vider</button>
    </div>
    <div class="build">V7.1</div>
  </div>

  <div class="card">
    <h2>Mes s√©ances</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>#</th><th>Date</th><th>Semaine</th><th>Activit√©</th><th>R√©sum√©</th><th>Actions</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="actions">
      <button class="btn ghost" id="exportCSV">Exporter CSV</button>
      <label class="btn ghost" for="importCSV">R√©importer CSV</label>
      <input id="importCSV" type="file" accept=".csv" style="display:none">
    </div>
  </div>
</div>
<div class="footer">Carnet d‚Äôentra√Ænement EPS - √âquipe EPS Lyc√©e Vauban - LUXEMBOURG - JB</div>

<script>
const nom = localStorage.getItem("ceps:last_nom")||"";
const prenom = localStorage.getItem("ceps:last_prenom")||"";
const classe = localStorage.getItem("ceps:last_classe")||"";
const tri = localStorage.getItem("ceps:last_tri")||"";
const apsa = localStorage.getItem("ceps:last_apsa")||"";
document.getElementById("who").textContent = nom+" "+prenom+" ‚Äî "+classe+" ‚Äî "+tri+" ‚Äî "+apsa;

const ta = document.getElementById("notes");
function refreshCounts(){
  const t = ta.value||"";
  document.getElementById("chars").textContent = t.length + " caract√®res";
  document.getElementById("words").textContent = countWords(t) + " mots";
}
ta.addEventListener("input",()=>{ ta.style.height="auto"; ta.style.height=(ta.scrollHeight+6)+"px"; refreshCounts(); });
refreshCounts();

function renderTable(){
  const tb = document.getElementById("tbody"); tb.innerHTML="";
  const d = loadCahier(nom, prenom, classe, tri);
  (d.seances||[]).forEach((r,i)=>{
    const tr = document.createElement("tr");
    const short = (r.Texte||"").slice(0,60) + ((r.Texte||"").length>60 ? "‚Ä¶" : "");
    tr.innerHTML = `<td>${r["S√©ance"]||i+1}</td>
                    <td>${r.Date||""}</td>
                    <td>${r.Semaine||""}</td>
                    <td>${r.Activit√©||""}</td>
                    <td>${short}</td>
                    <td style="white-space:nowrap">
                      <button class="btn ghost" data-i="${i}" data-act="qr">QR</button>
                      <button class="btn ghost" data-i="${i}" data-act="edit">‚úèÔ∏è</button>
                      <button class="btn warn" data-i="${i}" data-act="del">üóë</button>
                    </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll("button").forEach(btn=>btn.addEventListener("click",(ev)=>{
    const i = +ev.currentTarget.dataset.i;
    const act = ev.currentTarget.dataset.act;
    const d = loadCahier(nom, prenom, classe, tri);
    if(act==="del"){
      if(!confirm("Supprimer cette s√©ance ?")) return;
      d.seances.splice(i,1);
      d.seances = d.seances.map((s,idx)=>Object.assign({},s,{"S√©ance": idx+1}));
      saveCahier(nom, prenom, classe, tri, d);
      renderTable();
    } else if(act==="edit"){
      const row = d.seances[i];
      ta.value = row.Texte||"";
      ta.style.height="auto"; ta.style.height=(ta.scrollHeight+6)+"px";
      refreshCounts();
      EDIT_INDEX = i;
      document.getElementById("saveBtn").textContent = "Mettre √† jour la s√©ance #"+(i+1);
      window.scrollTo({top:0,behavior:"smooth"});
    } else if(act==="qr"){
      const row = d.seances[i];
      try{ sessionStorage.setItem("ceps:qr_payload", JSON.stringify(row)); }catch(e){}
      location.href = "qr.html?sid="+i+"&ts="+Date.now();
    }
  }));
}
renderTable();

document.getElementById("saveBtn").addEventListener("click",()=>{
  const d = loadCahier(nom, prenom, classe, tri);
  const now = new Date();
  if(EDIT_INDEX==null){
    const row = {
      "S√©ance": (d.seances?.length||0)+1,
      "Nom": nom, "Pr√©nom": prenom, "Classe": classe, "Trimestre": tri,
      "Date": now.toISOString().slice(0,10),
      "Semaine": isoWeek(now),
      "Activit√©": apsa,
      "Texte": ta.value||""
    };
    d.seances = d.seances||[]; d.seances.push(row);
  } else {
    d.seances[EDIT_INDEX].Texte = ta.value||"";
    EDIT_INDEX = null;
    document.getElementById("saveBtn").textContent = "Enregistrer ma s√©ance";
  }
  saveCahier(nom, prenom, classe, tri, d);
  renderTable();
  alert("S√©ance enregistr√©e.");
});

document.getElementById("clearBtn").addEventListener("click",()=>{ ta.value=""; refreshCounts(); ta.style.height="auto"; });

// === CSV export/import ===
function toCSV(rows){
  if(!rows.length) return "";
  const headers = Array.from(new Set(rows.flatMap(r=>Object.keys(r))));
  const esc=v=>(v==null?"":String(v).replace(/"/g,'""'));
  return [headers.join(","), ...rows.map(r=>headers.map(h=>`"${esc(r[h])}"`).join(","))].join("\n");
}
function fromCSV(text){
  const lines = text.split(/\r?\n/).filter(Boolean);
  if(!lines.length) return [];
  const headers = lines[0].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
  const rows = [];
  for (let i=1;i<lines.length;i++){
    const cols = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
    const obj = {};
    headers.forEach((h,idx)=>{
      const key = h.replace(/^"|"$/g,"");
      const val = (cols[idx]||"").replace(/^"|"$/g,"").replace(/""/g,'"');
      obj[key] = val;
    });
    rows.push(obj);
  }
  return rows;
}

document.getElementById("exportCSV").addEventListener("click",()=>{
  const rows = (loadCahier(nom, prenom, classe, tri).seances)||[];
  if(!rows.length) return alert("Aucune s√©ance √† exporter.");
  const csv = toCSV(rows);
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`CarnetEPS_${nom}_${prenom}_${classe}_${tri}.csv`; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),1000);
  alert("CSV export√©. Astuce: enregistre ¬´ Sur mon iPad ¬ª (local).");
});

document.getElementById("importCSV").addEventListener("change",(ev)=>{
  const f = ev.target.files?.[0]; if(!f) return;
  const fr = new FileReader();
  fr.onload = ()=>{
    try{
      const rows = fromCSV(fr.result);
      const renum = rows.map((s,idx)=>Object.assign({}, s, {"S√©ance": idx+1}));
      const d = loadCahier(nom, prenom, classe, tri); d.seances = renum; saveCahier(nom, prenom, classe, tri, d);
      renderTable();
      alert("CSV import√©.");
    }catch(e){ alert("Erreur CSV."); }
  };
  fr.readAsText(f);
});
</script>
</body></html>
